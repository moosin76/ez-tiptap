<template>
  <div v-if="editor">
    <template v-if="editable">
      <edit-top-menu :editor="editor" @uploadImage="uploadImage" />
      <!-- <edit-bubble-menu :editor="editor" />
      <edit-float-menu :editor="editor" /> -->
    </template>
    <editor-content :editor="editor" :class="{ 'ez-edit': editable }" />
  </div>
</template>

<script>

import EditTopMenu from "./tiptap/EditTopMenu.vue";
// import EditBubbleMenu from "./EditBubbleMenu.vue";
// import EditFloatMenu from "./EditFloatMenu.vue";

import { Editor, EditorContent } from "@tiptap/vue-2";
import StarterKit from "@tiptap/starter-kit";
import Document from "@tiptap/extension-document";
import Paragraph from "@tiptap/extension-paragraph";
import Heading from "@tiptap/extension-heading";
import Text from "@tiptap/extension-text";
import Highlight from "@tiptap/extension-highlight";
import Typography from "@tiptap/extension-typography";
import Table from "@tiptap/extension-table";
// import Table from './extension/CustomTable';
import TableRow from "@tiptap/extension-table-row";
import TableCell from "./tiptap/extension/CustomTableCell";
import TableHeader from "./tiptap/extension/CustomTableHeader";
// import TableHeader from "@tiptap/extension-table-header";
import TextAlign from "@tiptap/extension-text-align";
import TaskList from "@tiptap/extension-task-list";
import TaskItem from "./tiptap/extension/CustomTaskItem";
// import TaskItem from '@tiptap/extension-task-item';
import Dropcursor from "@tiptap/extension-dropcursor";
import CustomLink from "./tiptap/extension/CustomLink";
import CustomCodeBlock from "./tiptap/extension/CustomCodeBlock";
import CustomYoutube from "./tiptap/extension/CustomYoutube";
import TextColor from "./tiptap/extension/TextColor";
import TextStyle from "@tiptap/extension-text-style";
import FontFamily from "@tiptap/extension-font-family";
import FontSize from "./tiptap/extension/FontSize";
import BackgroundColor from "./tiptap/extension/BackgroundColor";
import Image from "./tiptap/extension/CustomImage";
import LineHeight from "./tiptap/extension/LineHeight";
import TextDecoration from "./tiptap/extension/TextDecoration";
import MarginTop from "./tiptap/extension/MarginTop";
import OrderedList from "@tiptap/extension-ordered-list";
import BulletList from "@tiptap/extension-bullet-list";
import GlobalDragHandle from "./tiptap/extension/GlobalDragHandle";

export default {
  name: "TiptapEditor",
  components: {
    EditorContent,
    EditTopMenu,
    // EditBubbleMenu,
    // EditFloatMenu,
  },
  props: {
    value: {
      type: String,
      default: "",
    },
    editable: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      editor: null,
    };
  },
  watch: {
    value(value) {
      const isSame = this.editor.getHTML() === value;
      if (isSame) return;
      this.editor.commands.setContent(this.value, false);
    },
		editable() {
			this.createEditor();
		}
  },
  mounted() {
    this.createEditor();
  },
  methods: {
    createEditor() {
      if (this.editor) this.editor.destroy();

      this.editor = new Editor({
        extensions: [
          StarterKit,
          Document,
          Paragraph.extend({
            addKeyboardShortcuts() {
              return {
                Tab: () => {
                  return this.editor.commands.insertContent([
                    {
                      type: "text",
                      text: "\t",
                    },
                  ]);
                },
              };
            },
          }),
          Heading,
          Text,
          Highlight.configure({ multicolor: true }),
          Typography,
          Table.configure({
            resizable: true,
          }),
          TableRow,
          TableCell,
          TableHeader,
          TextAlign,
          BulletList,
          OrderedList,
          TaskList,
          TaskItem,
          Dropcursor.extend({
            defaultOptions: {
              ...Dropcursor.options,
              color: "red",
              width: 3,
            },
          }),
          CustomLink.extend({
            defaultOptions: {
              ...CustomLink.options,
              openOnClick: !this.editable,
            },
          }),
          CustomCodeBlock,
          CustomYoutube,
          TextColor,
          TextStyle,
          FontFamily,
          FontSize,
          BackgroundColor,
          Image,
          LineHeight,
          TextDecoration,
          MarginTop,
					GlobalDragHandle,
        ],
        content: this.value,
        onUpdate: () => {
          this.$emit("input", this.editor.getHTML());
        },
        editorProps: {
          attributes: {
            spellcheck: "false",
          },
        },
        editable: this.editable,
      });
    },
    uploadImage(opt) {
      this.$emit("uploadImage", opt);
    },
  },
  beforeDestroy() {
    this.editor.destroy();
  },
};
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&family=Nanum+Brush+Script&family=Nanum+Gothic+Coding:wght@400;700&family=Nanum+Gothic:wght@400;700&family=Nanum+Myeongjo:wght@400;700&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR:wght@400;700&family=Song+Myung&family=Roboto+Mono:wght@400;700&display=swap');
.v-card__text .ProseMirror{color: black}
.sticky-menu{position: sticky; top: 64px; z-index: 1}
.top.menu {border-bottom: none;background: #fff;padding: 4px 8px 8px;}
.bubble.menu,
.top.menu > * {display: flex; flex-direction: row;flex-wrap: wrap;}
.floating.menu {display: flex;transform: translateY(-100%);}
.bubble.menu > *,
.top.menu > * > * {margin-top: 4px;}
.bubble.menu {border-radius: 5px;}
.ez-edit .ProseMirror {border: 1px solid #dee2e6; padding: 1em 0.5em 1em 2em; outline: none; border-top:none;min-height: 300px; }
.ProseMirror {font-size: 1rem;}
.ProseMirror p::after,
.ProseMirror::after {content: "";display: table;clear:both;}
.v-application .ProseMirror > * + *{margin-top: 0.75em;}
.ProseMirror ul,
.ProseMirror ol {padding-left: 2em}
.ProseMirror ul,
.ProseMirror ol {padding-left: 2em}
.ProseMirror ul[data-type='taskList'] {padding-left: 0.5em;}
.ProseMirror .tasklist {position: relative; padding-left: 2em;}
.ProseMirror .tasklist ul[data-type='taskList'] {margin-top: 0.5em;}
.ProseMirror .tasklist+.tasklist {margin-top: 0.75em;}
.ProseMirror .tasklist .tasklist-check {position: absolute; left:0px; top:0px}
.ProseMirror h1,
.ProseMirror h2,
.ProseMirror h3,
.ProseMirror h4,
.ProseMirror h5,
.ProseMirror h6 {line-height: 1.1;}
.ProseMirror p {margin-bottom: 0;}
.ProseMirror code {font-family: 'Roboto Mono', monospace;background-color: rgba(0, 0, 0, 0.3) !important;}
.ProseMirror .code-block {border-radius: 5px;overflow: hidden;}
.ProseMirror .code-block .v-btn--fab.v-size--small {height: 38px; width: 38px;}
.ProseMirror .code-block .code-block-info {background-color: #f5f5f5;}
/* .ProseMirror .code-block .lang-right input {text-align: right;} */
.ProseMirror .code-block-info * {border-radius: 0 !important;box-shadow: none !important;background-color: #eee !important;}
.ProseMirror pre {background: #FFF;color: #333;font-family: 'Roboto Mono', monospace;padding: 0.75em 1em;}
.ProseMirror pre code {color: inherit;padding: 0;background-color: transparent !important;font-size: 1em;user-select: text !important; tab-size: 2;}
.ProseMirror .code-block {position: relative;}
.ProseMirror .code-block .select{position: absolute;top: 0.5em;right: -0.5em;}
.ProseMirror img {max-width: 100%;height: auto;}
.ProseMirror img[style*="float : left"] {margin-right: 1em;}
.ProseMirror img[style*="float : right"] {margin-left: 1em;}
.ez-edit .ProseMirror img.ProseMirror-selectednode {outline: 3px solid #68CEF8;}
.ProseMirror blockquote {padding-left: 1em;border-left: 4px solid rgba(120, 120, 120, 0.1);}
.ProseMirror hr {border: none;border-top: 4px solid rgba(120, 120, 120, 0.1);}
.menu-bg {background-color: #fff;}
.theme--light.v-system-bar .v-icon {color: inherit;}
.tiptap-menu-button[aria-expanded='true'] i+i {transform: rotate(180deg);}
.tiptap-menu-button{ position: relative;}
.tiptap-menu-button .color-block {position: absolute;height: 6px;width: 60%;bottom:-5px;}
.ProseMirror table {border-collapse: collapse;table-layout: fixed;width: 100%;margin: 0;overflow: hidden;}
.ProseMirror table th,
.ProseMirror table td {min-width: 1em;border: 1px solid #ced4da;padding: 3px 5px;vertical-align: top;box-sizing: border-box;position: relative;}
.ProseMirror table >* {margin-bottom: 0;}
.ProseMirror table th {font-weight: bold;text-align: left;background-color: #f1f3f5;}
.ProseMirror table .selectedCell:after {z-index: 2;position: absolute;content: "";left: 0; right: 0; top: 0; bottom: 0;background: rgba(200, 200, 255, 0.1);pointer-events: none;}
.ProseMirror table .column-resize-handle {position: absolute;right: -2px;top: 0;bottom: -2px;width: 4px;background-color: #adf;pointer-events: none;}
.ProseMirror .tableWrapper {overflow-x: auto;}
.ProseMirror .resize-cursor {cursor: ew-resize;cursor: col-resize;}
.ez-edit .ProseMirror .drag-item {position: relative;}
.ez-edit .ProseMirror .drag-item .drag-handler {position: absolute;width: 1rem;height: 1rem;top: 0;left: -1.75em;cursor: grab; z-index: 2;}
.ez-edit .ProseMirror .youtube {margin-left: -1.75em; padding-left: 1.75em;}
.ez-edit .ProseMirror .youtube.drag-item:hover .drag-handler {left:0; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16"><path fill-opacity="0.5" fill="rgb(128,128,128)" d="M4 14c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zM2 6C.9 6 0 6.9 0 8s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6C.9 0 0 .9 0 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" /></svg>');background-repeat: no-repeat;background-size: contain;background-position: center;}
/*Global Drag*/
 .global-drag-handle {position: absolute;}
 .global-drag-handle::after {
	content: "";
	display: block;
	width: 1rem;
	height: 1rem;
	cursor: grab;
	background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16"><path fill-opacity="0.5" fill="rgb(128,128,128)" d="M4 14c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zM2 6C.9 6 0 6.9 0 8s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6C.9 0 0 .9 0 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" /></svg>');background-repeat: no-repeat;background-size: contain;background-position: center;
}
/* .ez-edit .ProseMirror .drag-item {margin-left: -1.75rem;} */
/* .ez-edit .ProseMirror .drag-item .drag-handler {position: absolute;width: 1rem;height: 1rem;top: 0;left: 0;cursor: grab;background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 16"><path fill-opacity="0.5" fill="rgb(128,128,128)" d="M4 14c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zM2 6C.9 6 0 6.9 0 8s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6C.9 0 0 .9 0 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" /></svg>');background-repeat: no-repeat;background-size: contain;background-position: center;}  */
.ez-edit .emoji .emoji-item .tooltip-padding {padding:0;}
.v-tabs--vertical>.v-tabs-bar .emoji-tab {transition: background-color 0.4s;height: 40px !important;}
.v-tabs--vertical>.v-tabs-bar .emoji-tab ~ .emoji-tab {border-top:1px solid #1976d280}
.v-tabs--vertical>.v-tabs-bar .emoji-tab.v-tab--active {background-color: #1976d220;}
.custom-color-picker .v-color-picker__color {height: 21px;width: 21px;margin: 2px 3px;}
.custom-color-picker .v-color-picker__swatches>div {justify-content: left;}
.custom-color-picker .v-color-picker__swatch {flex-direction: row;margin-bottom: 4px;}
.hljs {color: #24292e;background: #ffffff;}
.hljs-doctag,
.hljs-keyword,
.hljs-meta .hljs-keyword,
.hljs-template-tag,
.hljs-template-variable,
.hljs-type,
.hljs-variable.language_ {color: #d73a49;}
.hljs-title,
.hljs-title.class_,
.hljs-title.class_.inherited__,
.hljs-title.function_ {color: #6f42c1;}
.hljs-attr,
.hljs-attribute,
.hljs-literal,
.hljs-meta,
.hljs-number,
.hljs-operator,
.hljs-variable,
.hljs-selector-attr,
.hljs-selector-class,
.hljs-selector-id {color: #005cc5;}
.hljs-regexp,
.hljs-string,
.hljs-meta .hljs-string {color: #032f62;}
.hljs-built_in,
.hljs-symbol {color: #e36209;}
.hljs-comment,
.hljs-code,
.hljs-formula {color: #6a737d;}
.hljs-name,
.hljs-quote,
.hljs-selector-tag,
.hljs-selector-pseudo {color: #22863a;}
.hljs-subst {color: #24292e;}
.hljs-section {color: #005cc5;font-weight: bold;}
.hljs-bullet {color: #735c0f;}
.hljs-emphasis {color: #24292e;font-style: italic;}
.hljs-strong {color: #24292e;font-weight: bold;}
.hljs-addition {color: #22863a;background-color: #f0fff4;}
.hljs-deletion {color: #b31d28;background-color: #ffeef0;}
.theme--dark .ProseMirror-gapcursor:after {border-color: white}
.theme--dark .v-card__text .ProseMirror{color: hsla(0,0%,100%, 1)}
.theme--dark .top.menu {background-color: #4a4a4a;}
.theme--dark .bubble-menu ,
.theme--dark .top-menu > * {background: black;}
.theme--dark .ez-edit .ProseMirror {background-color: #1e1e1e; border: none;}
.theme--dark .ProseMirror .code-block-info {background-color: #121212;}
.theme--dark .ProseMirror .code-block-info * {background-color: #121212 !important;}
.theme--dark .ProseMirror pre {background-color: #333;color:#fff;}
.theme--dark .menu-bg {background-color: #000;}
.theme--dark .ProseMirror table th,
.theme--dark .ProseMirror table td {border-color: #333;}
.theme--dark .ProseMirror table th {background-color: #121212;}
.theme--dark .hljs {color: #c9d1d9;background: #0d1117;}
.theme--dark .hljs-doctag,
.theme--dark .hljs-keyword,
.theme--dark .hljs-meta .hljs-keyword,
.theme--dark .hljs-template-tag,
.theme--dark .hljs-template-variable,
.theme--dark .hljs-type,
.theme--dark .hljs-variable.language_ {color: #ff7b72;}
.theme--dark .hljs-title,
.theme--dark .hljs-title.class_,
.theme--dark .hljs-title.class_.inherited__,
.theme--dark .hljs-title.function_ {color: #d2a8ff;}
.theme--dark .hljs-attr,
.theme--dark .hljs-attribute,
.theme--dark .hljs-literal,
.theme--dark .hljs-meta,
.theme--dark .hljs-number,
.theme--dark .hljs-operator,
.theme--dark .hljs-variable,
.theme--dark .hljs-selector-attr,
.theme--dark .hljs-selector-class,
.theme--dark .hljs-selector-id {color: #79c0ff;}
.theme--dark .hljs-regexp,
.theme--dark .hljs-string,
.theme--dark .hljs-meta .hljs-string {color: #a5d6ff;}
.theme--dark .hljs-built_in,
.theme--dark .hljs-symbol {color: #ffa657;}
.theme--dark .hljs-comment,
.theme--dark .hljs-code,
.theme--dark .hljs-formula {color: #8b949e;}
.theme--dark .hljs-name,
.theme--dark .hljs-quote,
.theme--dark .hljs-selector-tag,
.theme--dark .hljs-selector-pseudo {color: #7ee787;}
.theme--dark .hljs-subst {color: #c9d1d9;}
.theme--dark .hljs-section {color: #1f6feb;font-weight: bold;}
.theme--dark .hljs-bullet {color: #f2cc60;}
.theme--dark .hljs-emphasis {color: #c9d1d9;font-style: italic;}
.theme--dark .hljs-strong {color: #c9d1d9;font-weight: bold;}
.theme--dark .hljs-addition {color: #aff5b4;background-color: #033a16;}
.theme--dark .hljs-deletion {color: #ffdcd7;background-color: #67060c;}
</style>